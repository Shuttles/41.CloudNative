# 1.限制

1. 也许你会好奇，我们不是已经通过 Linux Namespace 创建了一个“容器”吗，为什么还需要对容器做“**限制**”呢？

   我还是以 PID Namespace 为例，来给你解释这个问题。

2. 虽然容器内的第 1 号进程在“障眼法”的干扰下只能看到容器里的情况，但是宿主机上，**它作为第 100 号进程与其他所有进程之间依然是平等的竞争关系**。

   这就意味着，**虽然第 100 号进程表面上被隔离了起来**，**但是它所能够使用到的资源（比如 CPU、内存），却是可以随时被宿主机上的其他进程（或者其他容器）占用的。**当然，这个 100 号进程自己也可能把所有资源吃光。

   **这些情况，显然都不是一个“沙盒”应该表现出来的合理行为**。



# 2.Cgroups

1. **Linux Cgroups 就是 Linux 内核中用来==为进程设置资源限制==的一个重要功能。**

2. Linux Cgroups 的全称是 `Linux Control Group`。它最主要的作用，就是**限制一个进程组能够使用的资源上限**，包括 CPU、内存、磁盘、网络带宽等等。

3. 在 Linux 中，Cgroups 给用户暴露出来的操作接口是**文件系统，即它以文件和目录的方式**组织在操作系统的 /sys/fs/cgroup 路径下。

4. 可以看到，在 /sys/fs/cgroup 下面有很多诸如 cpuset、cpu、 memory 这样的子目录，也叫**子系统**。这些都是我这台机器当前可以被 Cgroups 进行限制的**资源种类**。而在子系统对应的资源种类下，你就可以看到该类资源具体可以被限制的方法。

5. **Linux Cgroups 的设计还是比较易用的，简单粗暴地理解呢，它就是==一个子系统目录加上一组资源限制文件的组合==**。

6. 而对于 Docker 等 Linux 容器项目来说，它们只需要==**在每个子系统下面，为每个容器创建一个控制组（即创建一个新目录）**，然后在启动容器进程之后，把这个进程的 PID 填写到对应控制组的 tasks 文件中就可以了。==

   而至于在这些控制组下面的资源文件里填上什么值，就靠**用户执行 docker run 时的参数**指定了



# 3.容器本质

1. 一个正在运行的 Docker 容器，其实就是一个启用了**多个 Linux Namespace 的应用进程**，而这个进程能够使用的资源量，则**受 Cgroups 配置的限制**。

2. 这也是容器技术中一个非常重要的概念，即：**容器是一个“单进程”模型。**

3. 由于一个容器的本质就是**一个进程**，用户的**应用进程实际上就是容器里 PID=1 的进程**，也是其他后续创建的所有进程的父进程。

   这就意味着，在一个容器中，你**没办法同时运行两个不同的应用**，除非你能事先找到一个公共的 PID=1 的程序来充当两个不同应用的父进程，这也是为什么很多人都会用 systemd 或者 supervisord 这样的软件来代替应用本身作为容器的启动进程。

4. Q：是不是可以理解：一个docker里面跑的进程都是docker这个进程的子进程？

   A：不。==是entrypoint进程的子进程。docker基本上是旁路控制的作用。==





# 4.Cgroups缺点

1. 另外，跟 Namespace 的情况类似，Cgroups 对资源的限制能力也有很多不完善的地方，被提及最多的自然是 **/proc 文件系统**的问题。
2. 众所周知，Linux 下的 /proc 目录存储的是**记录当前内核运行状态的一系列特殊文件**，用户可以通过访问这些文件，**查看系统以及当前正在运行的进程的信息**，比如 CPU 使用情况、内存占用率等，这些文件也是 `top `指令查看系统信息的主要数据来源。
3. 但是，你如果在容器里执行 top 指令，就会发现，它显示的信息居然是宿主机的 CPU 和内存数据，而不是当前容器的数据。
4. 造成这个问题的原因就是，/proc 文件系统并不知道用户通过 Cgroups 给这个容器做了什么样的资源限制，即：/proc 文件系统不了解 Cgroups 限制的存在。
5. 在生产环境中，这个问题必须进行修正，否则应用程序在容器里读取到的 CPU 核数、可用内存等信息都是宿主机上的数据，这会给应用的运行带来非常大的**困惑和风险**。这也是在企业中，容器化应用碰到的一个常见问题，也是容器相较于虚拟机另一个不尽如人意的地方。





参考文献

[file:///home/chenzheyu/41.cloud/%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90k8s/06%E4%B8%A8%E7%99%BD%E8%AF%9D%E5%AE%B9%E5%99%A8%E5%9F%BA%E7%A1%80%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E9%9A%94%E7%A6%BB%E4%B8%8E%E9%99%90%E5%88%B6.html](file:///home/chenzheyu/41.cloud/深入剖析k8s/06丨白话容器基础（二）：隔离与限制.html)